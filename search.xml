<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Windows PE でのネットワーク経由カーネル デバッガ接続方法について</title>
      <link href="/blog/2020/07/29/winpe-kernel-debug-via-network/"/>
      <url>/blog/2020/07/29/winpe-kernel-debug-via-network/</url>
      
        <content type="html"><![CDATA[<p>Windows PE でのネットワーク経由のカーネルデバッガ接続方法についてご紹介します。</p><a id="more"></a><br><hr><p>Windows PE でのシリアルケーブル経由でのカーネルデバッガ接続方法は、以下のドキュメントが公開されております。この方法では、カーネルデバッガを起動する側であるホスト PC を選びません。  </p><ul><li><a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-debug-apps#kernel-mode-debugging" target="_blank" rel="noopener">WinPE: Debug Apps - Kernel-mode debugging</a>  </li></ul><p>対しまして、今回ご紹介するネットワーク経由のカーネルデバッガ接続方法では、通常、以下のブログでご紹介したような kdnet.exe は、ターゲット PC の再起動が必要となるため使えず、予めホスト PC の IP アドレスを Windows PE 側の BCD に設定しておく必要があります。  </p><ul><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/db91ddff-f8ff-49d8-bef2-2a0c596414c2/hyperv-?forum=wdksupportteamja" target="_blank" rel="noopener">Hyper-V 仮想マシンへのネットワーク経由のカーネルデバッガ接続方法</a>  </li></ul><p>それでは、具体的な手順を紹介します。</p><hr><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>今回は、Windows PE のイメージ作成を行う環境と、カーネルデバッガを起動するホスト PC は同じ PC とします。そして、その PC の Hyper-V 仮想マシン (UEFI を使うため第二世代、セキュアブートは OFF) を、ターゲット PC として、Windows PE の ISO を読ませるようにします。  </p><p>ホスト PC には、以下のリンクから、Windows ADK for Windows 10 バージョン 1903 と、ADK 用の Windows PE アドオンをインストールしています。  </p><ul><li><p><a href="https://docs.microsoft.com/ja-jp/windows-hardware/get-started/adk-install" target="_blank" rel="noopener">Windows ADK のダウンロードとインストール</a></p></li><li><p><a href="https://go.microsoft.com/fwlink/?linkid=2086042" target="_blank" rel="noopener">Windows ADK for Windows 10、バージョン 1903 のダウンロード</a></p></li><li><p><a href="https://go.microsoft.com/fwlink/?linkid=2087112" target="_blank" rel="noopener">ADK 用の Windows PE アドオンのダウンロード</a></p></li></ul><hr><h3 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h3><p>(1) [スタート] -&gt; [Windows Kits] -&gt; [展開およびイメージング ツール環境] を管理者権限で起動します。</p><p>(2) copype.exe で、例として D:\WinPE_amd64 に作業用ディレクトリを作成します。<br>(D ドライブの使用は例であり、任意の場所で問題ありません。また、すでに D:\WinPE_amd64 が存在する場合は、コマンドがエラーとなるため、事前に削除しておきます。)</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> copype amd64 d:\WinPE_amd64</span></span><br></pre></td></tr></table></figure><p>(3) 以下のコマンドを実行し、Windows PE 環境側のネットワーク接続でのカーネルデバッグ設定を行います。  </p><ul><li><p>(3-A) Windows PE 環境が UEFI の場合</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\EFI\Microsoft\Boot\BCD &#x2F;set &#123;default&#125; debug on</span><br><span class="line"></span><br><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\EFI\Microsoft\Boot\BCD &#x2F;set &#123;default&#125; bootdebug on</span><br><span class="line"></span><br><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\EFI\Microsoft\Boot\BCD &#x2F;dbgsettings NET HOSTIP:&lt;カーネルデバッガを起動するホスト PC の IP アドレス、xxx.xxx.xxx.xxx&gt; PORT:50005 key:5.5.5.5</span><br></pre></td></tr></table></figure></li><li><p>(3-B) Windows PE 環境がレガシー BIOS の場合</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\Boot\BCD &#x2F;set &#123;default&#125; debug on</span><br><span class="line"></span><br><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\Boot\BCD &#x2F;set &#123;default&#125; bootdebug on</span><br><span class="line"></span><br><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\Boot\BCD &#x2F;dbgsettings NET HOSTIP:&lt;カーネルデバッガを起動するホスト PC の IP アドレス、xxx.xxx.xxx.xxx&gt; PORT:50005 key:5.5.5.5</span><br></pre></td></tr></table></figure><p> <code>PORT の 50005 と key の 5.5.5.5 は例です。</code></p></li></ul><p>(4) 以下のコマンドを実行し、設定した結果に問題ないか確認します。  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; bcdedit &#x2F;store d:\WinPE_amd64\media\EFI\Microsoft\Boot\BCD &#x2F;dbgsettings</span><br><span class="line">   key                     5.5.5.5</span><br><span class="line">   debugtype               NET</span><br><span class="line">   hostip                  xxx.xxx.xxx.xxx</span><br><span class="line">   port                    50005</span><br><span class="line">   dhcp                    Yes</span><br></pre></td></tr></table></figure><p>(5) 上記が完了したら、以下のコマンドで Windows PE の ISO ファイルを作成します。  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; makewinpemedia &#x2F;iso d:\WinPE_amd64\winpe_x64_debug.iso</span><br></pre></td></tr></table></figure><p>(6) 上記の ISO ファイルで Hyper-V 仮想環境 (第二世代、セキュアブートなし) を作成します。  </p><p>(上記の手順 (3) で、(3-A) で設定を行ったことが前提です。第一世代ですと、UEFI ではないため、(3-B) でないとカーネルデバッグ接続できません。また、セキュアブートは無効にする必要があります。)  </p><p>使用する仮想スイッチは、上記「<a href="https://social.msdn.microsoft.com/Forums/ja-JP/db91ddff-f8ff-49d8-bef2-2a0c596414c2/hyperv?forum=wdksupportteamja" target="_blank" rel="noopener">Hyper-V 仮想マシンへのネットワーク経由のカーネルデバッガ接続方法</a>」の「1. ホストPC と仮想マシンをネットワーク接続します。」と同じものを使っています。</p><div align="left"><img src="https://jpwdkblog.github.io/images/SecureBootSetting.png"></div><p>(7) カーネルデバッガ側は、以下のコマンドを実行することで Windows PE のターゲットにデバッガ接続し、ブレークインできます。<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; windbg.exe -k net:port&#x3D;50005,key&#x3D;5.5.5.5</span><br></pre></td></tr></table></figure><br><br></p><p>以上の内容がお役に立てば幸いです。  </p><hr><p><code>変更履歴</code><br><code>2020/07/29 created by Tsuda</code>  </p>]]></content>
      
      
      <categories>
          
          <category> Windows PE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> カーネル デバッグ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>過去ブログについて</title>
      <link href="/blog/2020/01/12/past-blog/"/>
      <url>/blog/2020/01/12/past-blog/</url>
      
        <content type="html"><![CDATA[<p>過去のブログ情報を紹介いたします。</p><a id="more"></a><h2 id="WDK"><a href="#WDK" class="headerlink" title="WDK"></a>WDK</h2><p>投稿数が多いため、全て確認する場合には下記サイトをご参照ください。<br><a href="https://social.msdn.microsoft.com/Forums/ja-JP/home?forum=wdksupportteamja" target="_blank" rel="noopener">https://social.msdn.microsoft.com/Forums/ja-JP/home?forum=wdksupportteamja</a></p><ul><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/521847f9-f90a-4f2b-81eb-3efb57b34152/windows-10-iot-core-com-?forum=wdksupportteamja" target="_blank" rel="noopener">Windows 10 IoT Core 環境の COM ポートの割り当てについて</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/e1979c21-d197-4fb2-a0b4-bb3d2c67337f/wia-wiadriverex-?forum=wdksupportteamja" target="_blank" rel="noopener">WIA ミニドライバーサンプル wiadriverex をデバッグする</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/3842e76b-676d-44ce-b1ae-1ff324b9c3b3/visual-studio-2015-123911239812486124731248832626215172604127861?forum=wdksupportteamja" target="_blank" rel="noopener">Visual Studio 2015 でのテスト署名方法</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/d74842f6-5c05-44ad-b98d-3f26874a5647/12459125401249312523125141254012489-1248712496124831246012391?forum=wdksupportteamja" target="_blank" rel="noopener">カーネルモード デバッガで UMDF ドライバをライブデバッグする</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/06aafefe-ba4c-407e-a4c4-36562d6c6da4/v4-?forum=wdksupportteamja" target="_blank" rel="noopener">V4 プリンター ドライバのデバッガアタッチ方法</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/dd9447a6-6221-407e-9f01-a19b86d77567/-?forum=wdksupportteamja" target="_blank" rel="noopener">デバイスマネージャーの [表示] を [デバイス (接続別)] に切り替える</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/ffae3a15-11af-4ab2-8341-4f004356a6d0?forum=wdksupportteamja" target="_blank" rel="noopener">ダンプファイルに保存されたイベントログを取り出す</a></li><li><a href="https://social.msdn.microsoft.com/Forums/ja-JP/8ff7b651-dcd1-4721-ab34-12c192fa0e4f/12480125311250312501124491245212523123952044523384123731242812?forum=wdksupportteamja" target="_blank" rel="noopener">ダンプファイルに保存された ETW トレースログを表示する</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Windows Driver Kit 全般 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 過去ブログ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jpwdkblog について</title>
      <link href="/blog/2020/01/01/aobut-jpwdkblog/"/>
      <url>/blog/2020/01/01/aobut-jpwdkblog/</url>
      
        <content type="html"><![CDATA[<p>日本マイクロソフトの Windows Driver Kit に関するサポート情報のブログです。</p><h3 id="公開日"><a href="#公開日" class="headerlink" title="公開日"></a>公開日</h3><p>2020 年 1 月 1 日より公開いたしました。</p><h3 id="活動について"><a href="#活動について" class="headerlink" title="活動について"></a>活動について</h3><p>製品のサポート メンバーによって運用されております。仕様に関する情報やトラブル シューティングの手順、実装におけるワンポイント アドバイスを公開いたします。</p><h3 id="留意事項"><a href="#留意事項" class="headerlink" title="留意事項"></a>留意事項</h3><p>サイトのコンテンツや情報において、可能な限り正確な情報を掲載し、更新するよう努めております。しかしながら、状況の変化や情報が古くなることにより、必ずしもお客様環境に適用できない情報となる場合がございます。恐れ入りますが、予めご留意くださいますようお願い申し上げます。</p>]]></content>
      
      
      <categories>
          
          <category> Windows Driver Kit 全般 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> はじめに </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
